<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proveedores y Pedidos - Comics POS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Axios for API requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"
    ></script>
    <script type="text/javascript">
      (function () {
        emailjs.init("uHkL4ndGHfowv1GB_"); // Reemplaza con tu User ID de EmailJS
      })();
    </script>
    <style>
      .logo-shape::before {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        background-color: black;
        margin-right: 10px;
        clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 70%, 0 100%);
      }

      /* Estilos para el men√∫ de usuario */

      .user-menu:hover {
        background-color: #f5f5f5;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e32929;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 10px;
      }

      .user-name {
        font-weight: 500;
      }

      .dropdown-icon {
        margin-left: 8px;
        font-size: 12px;
        transition: transform 0.2s;
      }

      .user-menu:hover .dropdown-icon {
        transform: rotate(180deg);
      }

      /* Estilos para el contenido desplegable */
      .dropdown-content {
        position: absolute;
        top: 100%;
        right: 0;
        background-color: white;
        min-width: 220px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 15px;
        display: none;
        z-index: 1000;
      }

      .user-menu:hover .dropdown-content {
        display: block;
      }

      .user-info {
        margin-bottom: 15px;
      }

      .info-item {
        padding: 5px 0;
        font-size: 14px;
        color: #333;
      }

      .dropdown-divider {
        height: 1px;
        background-color: #eee;
        margin: 10px 0;
      }

      .dropdown-content a {
        display: block;
        padding: 8px 0;
        text-decoration: none;
        color: #e32929;
        font-size: 14px;
        font-weight: 500;
        transition: opacity 0.2s;
      }

      .dropdown-content a:hover {
        opacity: 0.8;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 30px;
        background-color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      nav {
        display: flex;
        align-items: center;
      }

      .nav-links {
        display: flex;
        list-style: none;
        gap: 30px;
        margin-right: 20px;
      }

      /* Ajustar user-menu para asegurar que est√© correctamente posicionado */
      .user-menu {
        position: relative;
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .logo {
        font-weight: 900;
        font-size: 24px;
        display: flex;
        align-items: center;
      }

      .logo::before {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        background-color: black;
        margin-right: 10px;
        clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 70%, 0 100%);
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col">
    <header>
      <div class="logo">COMICS</div>
      <nav>
        <ul class="nav-links">
          <li><a href="{{ url_for('productos') }}">Productos</a></li>
          <li><a href="{{ url_for('empleados') }}">Empleados</a></li>
          <li><a href="{{ url_for('pedidos') }}">Pedidos</a></li>
          <li><a href="{{ url_for('proveedores') }}">Proveedores</a></li>
          <li><a href="{{ url_for('clientes') }}">Clientes</a></li>
        </ul>

        <!-- Perfil de usuario fuera del ul pero dentro de nav -->
        <div class="user-menu" id="user-profile">
          <div class="user-avatar" id="user-initials">A</div>
          <span class="user-name" id="user-display-name">Admin</span>
          <span class="dropdown-icon">‚ñº</span>

          <div class="dropdown-content">
            <div class="user-info">
              <div class="info-item" id="user-full-name">Nombre completo</div>
              <div class="info-item" id="user-role">Rol: Administrador</div>
              <div class="info-item" id="user-position">Puesto: Gerente</div>
            </div>
            <div class="dropdown-divider"></div>
            <a href="#" onclick="logout()">Cerrar sesi√≥n</a>
          </div>
        </div>
      </nav>
    </header>

    <!-- Main content -->
    <div class="flex-1 p-6 max-w-7xl mx-auto w-full">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Proveedores y Pedidos</h1>
        <button
          id="addProviderBtn"
          class="bg-red-600 text-white px-4 py-2 rounded font-semibold hover:bg-red-700 transition"
        >
          + Agregar Proveedor
        </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex border-b border-gray-300 mb-6">
        <button
          id="proveedoresTab"
          class="px-5 py-3 font-medium relative text-red-600 after:content-[''] after:absolute after:w-full after:h-0.5 after:bg-red-600 after:bottom-0 after:left-0"
        >
          Proveedores
        </button>
        <button
          id="pedidosTab"
          class="px-5 py-3 font-medium text-gray-700 hover:text-gray-900"
        >
          Pedidos a Proveedores
        </button>
      </div>

      <!-- Search and Filters -->
      <div class="bg-white p-5 rounded-lg shadow-sm mb-6">
        <div class="flex mb-4">
          <input
            type="text"
            id="searchInput"
            class="flex-1 border border-gray-300 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            placeholder="Buscar proveedores..."
          />
          <button
            id="searchBtn"
            class="bg-red-600 text-white px-5 py-2 rounded-r-lg hover:bg-red-700 transition"
          >
            üîç
          </button>
        </div>

        <div class="flex flex-wrap gap-4">
          <div class="flex items-center">
            <span class="font-semibold text-sm mr-2">Categor√≠a:</span>
            <select
              id="categoryFilter"
              class="border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            >
              <option value="all">Todos</option>
              <option value="comics">Comics</option>
              <option value="manga">Manga</option>
              <option value="merch">Merchandising</option>
            </select>
          </div>

          <div class="flex items-center">
            <span class="font-semibold text-sm mr-2">Estado:</span>
            <select
              id="statusFilter"
              class="border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            >
              <option value="all">Todos</option>
              <option value="1">Activo</option>
              <option value="2">Inactivo</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Tab Content -->
      <div id="proveedoresContent" class="block">
        <!-- Providers Grid -->
        <div
          id="proveedoresGrid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        >
          <!-- Provider cards will be loaded here dynamically -->
        </div>

        <!-- Pagination -->
        <div class="flex justify-center mt-8">
          <div class="flex space-x-1">
            <button
              class="w-9 h-9 flex items-center justify-center rounded bg-white shadow-sm hover:bg-gray-100 transition"
            >
              ¬´
            </button>
            <button
              class="w-9 h-9 flex items-center justify-center rounded bg-red-600 text-white"
            >
              1
            </button>
            <button
              class="w-9 h-9 flex items-center justify-center rounded bg-white shadow-sm hover:bg-gray-100 transition"
            >
              2
            </button>
            <button
              class="w-9 h-9 flex items-center justify-center rounded bg-white shadow-sm hover:bg-gray-100 transition"
            >
              3
            </button>
            <button
              class="w-9 h-9 flex items-center justify-center rounded bg-white shadow-sm hover:bg-gray-100 transition"
            >
              ¬ª
            </button>
          </div>
        </div>
      </div>

      <div id="pedidosContent" class="hidden">
        <!-- Orders section -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
          <div
            class="flex justify-between items-center p-5 border-b border-gray-200"
          >
            <h2 class="text-lg font-semibold">Pedidos a Proveedores</h2>
            <button
              id="addOrderBtn"
              class="bg-green-600 text-white px-4 py-2 rounded font-semibold hover:bg-green-700 transition"
            >
              + Nuevo Pedido
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Pedido #
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Proveedor
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Fecha
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Total
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Estado
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Acciones
                  </th>
                </tr>
              </thead>
              <tbody
                id="pedidosTableBody"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- Order rows will be loaded here dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for adding/editing providers -->
    <div
      id="providerModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg w-full max-w-xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 id="modalTitle" class="text-xl font-bold">Agregar Proveedor</h2>
          <button
            id="closeProviderModal"
            class="text-gray-500 hover:text-gray-700 text-2xl"
          >
            &times;
          </button>
        </div>

        <form id="providerForm" class="space-y-4">
          <input type="hidden" id="providerId" value="" />

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="providerName"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Nombre *</label
              >
              <input
                type="text"
                id="providerName"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                required
              />
            </div>

            <div>
              <label
                for="providerEmail"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Email *</label
              >
              <input
                type="email"
                id="providerEmail"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                required
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="providerPhone"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Tel√©fono</label
              >
              <input
                type="text"
                id="providerPhone"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>

            <div>
              <label
                for="providerDelivery"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Tiempo de entrega (d√≠as)</label
              >
              <input
                type="number"
                id="providerDelivery"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                min="1"
              />
            </div>
          </div>

          <div>
            <label
              for="providerAddress"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Direcci√≥n</label
            >
            <input
              type="text"
              id="providerAddress"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label
                for="providerCity"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Ciudad</label
              >
              <input
                type="text"
                id="providerCity"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>

            <div>
              <label
                for="providerState"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Estado</label
              >
              <input
                type="text"
                id="providerState"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>

            <div>
              <label
                for="providerZip"
                class="block text-sm font-medium text-gray-700 mb-1"
                >C√≥digo Postal</label
              >
              <input
                type="text"
                id="providerZip"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>
          </div>

          <div>
            <label
              for="providerNotes"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Notas</label
            >
            <textarea
              id="providerNotes"
              rows="3"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            ></textarea>
          </div>

          <div class="flex justify-end pt-4">
            <button
              type="button"
              id="cancelProviderBtn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded mr-2 hover:bg-gray-300 transition"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
            >
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal for creating orders -->
    <div
      id="orderModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg w-full max-w-4xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Nuevo Pedido a Proveedor</h2>
          <button
            id="closeOrderModal"
            class="text-gray-500 hover:text-gray-700 text-2xl"
          >
            &times;
          </button>
        </div>

        <form id="orderForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="orderProvider"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Proveedor *</label
              >
              <select
                id="orderProvider"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                required
              >
                <option value="">Seleccionar proveedor</option>
                <!-- Providers will be loaded here dynamically -->
              </select>
            </div>

            <div>
              <label
                for="orderExpectedDate"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Fecha estimada de llegada</label
              >
              <input
                type="date"
                id="orderExpectedDate"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>
          </div>

          <div>
            <label
              for="orderNotes"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Notas</label
            >
            <textarea
              id="orderNotes"
              rows="2"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            ></textarea>
          </div>

          <div>
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-medium">Productos</h3>
              <button
                type="button"
                id="addProductBtn"
                class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition"
              >
                + Agregar Producto
              </button>
            </div>

            <div class="overflow-x-auto border border-gray-200 rounded">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Producto
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Cantidad
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Precio Unitario
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Subtotal
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="orderDetailsList"
                  class="bg-white divide-y divide-gray-200"
                >
                  <!-- Product rows will be added here dynamically -->
                  <tr id="noProductsRow">
                    <td
                      colspan="5"
                      class="px-4 py-3 text-sm text-gray-500 text-center"
                    >
                      No hay productos agregados
                    </td>
                  </tr>
                </tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-medium"
                    >
                      Subtotal:
                    </td>
                    <td
                      class="px-4 py-3 text-sm font-medium"
                      id="orderSubtotal"
                    >
                      $0.00
                    </td>
                    <td></td>
                  </tr>
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-medium"
                    >
                      IVA (16%):
                    </td>
                    <td class="px-4 py-3 text-sm font-medium" id="orderTax">
                      $0.00
                    </td>
                    <td></td>
                  </tr>
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-bold"
                    >
                      Total:
                    </td>
                    <td class="px-4 py-3 text-sm font-bold" id="orderTotal">
                      $0.00
                    </td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="flex justify-end pt-4">
            <button
              type="button"
              id="cancelOrderBtn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded mr-2 hover:bg-gray-300 transition"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
            >
              Crear Pedido
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal for adding products to order -->
    <div
      id="productModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Agregar Producto</h2>
          <button
            id="closeProductModal"
            class="text-gray-500 hover:text-gray-700 text-2xl"
          >
            &times;
          </button>
        </div>

        <form id="productForm" class="space-y-4">
          <div>
            <label
              for="productSelect"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Producto *</label
            >
            <select
              id="productSelect"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              required
            >
              <option value="">Seleccionar producto</option>
              <!-- Products will be loaded here dynamically -->
            </select>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="productQuantity"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Cantidad *</label
              >
              <input
                type="number"
                id="productQuantity"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                min="1"
                value="1"
                required
              />
            </div>

            <div>
              <label
                for="productPrice"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Precio Unitario *</label
              >
              <input
                type="number"
                id="productPrice"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                min="0.01"
                step="0.01"
                required
              />
            </div>
          </div>

          <div class="flex justify-end pt-4">
            <button
              type="button"
              id="cancelProductBtn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded mr-2 hover:bg-gray-300 transition"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
            >
              Agregar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Details Modal for viewing order details -->
    <div
      id="detailsModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg w-full max-w-4xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 id="detailsTitle" class="text-xl font-bold">
            Detalles del Pedido
          </h2>
          <button
            id="closeDetailsModal"
            class="text-gray-500 hover:text-gray-700 text-2xl"
          >
            &times;
          </button>
        </div>

        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-500">N√∫mero de Pedido</p>
              <p id="detailsNumber" class="font-medium">-</p>
            </div>

            <div>
              <p class="text-sm text-gray-500">Estado</p>
              <p id="detailsStatus" class="font-medium">-</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-500">Proveedor</p>
              <p id="detailsProvider" class="font-medium">-</p>
            </div>

            <div>
              <p class="text-sm text-gray-500">Fecha de Orden</p>
              <p id="detailsDate" class="font-medium">-</p>
            </div>
          </div>

          <div>
            <p class="text-sm text-gray-500">Notas</p>
            <p id="detailsNotes" class="font-medium">-</p>
          </div>

          <div>
            <h3 class="font-medium mb-2">Productos</h3>

            <div class="overflow-x-auto border border-gray-200 rounded">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Producto
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Cantidad
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Precio Unitario
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Subtotal
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="detailsProductList"
                  class="bg-white divide-y divide-gray-200"
                >
                  <!-- Product details will be loaded here dynamically -->
                </tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-medium"
                    >
                      Subtotal:
                    </td>
                    <td
                      class="px-4 py-3 text-sm font-medium"
                      id="detailsSubtotal"
                    >
                      $0.00
                    </td>
                  </tr>
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-medium"
                    >
                      IVA (16%):
                    </td>
                    <td class="px-4 py-3 text-sm font-medium" id="detailsTax">
                      $0.00
                    </td>
                  </tr>
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-bold"
                    >
                      Total:
                    </td>
                    <td class="px-4 py-3 text-sm font-bold" id="detailsTotal">
                      $0.00
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="flex justify-end pt-4">
            <button
              type="button"
              id="closeDetailsBtn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // API URL
      const API_BASE_URL = "http://127.0.0.1:8000";

      let currentProviders = [];
      let currentOrders = [];
      let currentProducts = [];
      let orderDetails = [];
      let selectedProviderId = null;
      axios.defaults.baseURL = API_BASE_URL; // Ajusta esta URL seg√∫n tu configuraci√≥n

      console.log("API Base URL:", API_BASE_URL);

      // A√±ade estos interceptores para depuraci√≥n
      axios.interceptors.request.use(
        (request) => {
          console.log("Enviando solicitud a:", request.url);
          console.log("Datos enviados:", request.data);
          console.log("M√©todo:", request.method);
          console.log("Headers:", request.headers);
          return request;
        },
        (error) => {
          console.error("Error en la solicitud:", error);
          return Promise.reject(error);
        }
      );

      axios.interceptors.response.use(
        (response) => {
          console.log("Respuesta recibida de:", response.config.url);
          console.log("Datos recibidos:", response.data);
          console.log("C√≥digo de estado:", response.status);
          return response;
        },
        (error) => {
          console.error("Error en la respuesta:", error);
          if (error.response) {
            console.error("Datos del error:", error.response.data);
            console.error("Estado del error:", error.response.status);
          }
          return Promise.reject(error);
        }
      );

      function initDOMReferences() {
        console.log("Inicializando referencias DOM...");

        // Tab navigation
        window.proveedoresTab = document.getElementById("proveedoresTab");
        window.pedidosTab = document.getElementById("pedidosTab");
        window.proveedoresContent =
          document.getElementById("proveedoresContent");
        window.pedidosContent = document.getElementById("pedidosContent");
        window.proveedoresGrid = document.getElementById("proveedoresGrid");
        window.pedidosTableBody = document.getElementById("pedidosTableBody");
        window.searchInput = document.getElementById("searchInput");
        window.searchBtn = document.getElementById("searchBtn");
        window.categoryFilter = document.getElementById("categoryFilter");
        window.statusFilter = document.getElementById("statusFilter");

        // Proveedores modals
        window.providerModal = document.getElementById("providerModal");
        window.closeProviderModal =
          document.getElementById("closeProviderModal");
        window.addProviderBtn = document.getElementById("addProviderBtn");
        window.providerForm = document.getElementById("providerForm");
        window.modalTitle = document.getElementById("modalTitle");
        window.providerId = document.getElementById("providerId");
        window.providerName = document.getElementById("providerName");
        window.providerEmail = document.getElementById("providerEmail");
        window.providerPhone = document.getElementById("providerPhone");
        window.providerDelivery = document.getElementById("providerDelivery");
        window.providerAddress = document.getElementById("providerAddress");
        window.providerCity = document.getElementById("providerCity");
        window.providerState = document.getElementById("providerState");
        window.providerZip = document.getElementById("providerZip");
        window.providerNotes = document.getElementById("providerNotes");
        window.cancelProviderBtn = document.getElementById("cancelProviderBtn");

        // Pedidos modals
        window.orderModal = document.getElementById("orderModal");
        window.closeOrderModal = document.getElementById("closeOrderModal");
        window.addOrderBtn = document.getElementById("addOrderBtn");
        window.orderForm = document.getElementById("orderForm");
        window.orderProvider = document.getElementById("orderProvider");
        window.orderExpectedDate = document.getElementById("orderExpectedDate");
        window.orderNotes = document.getElementById("orderNotes");
        window.orderDetailsList = document.getElementById("orderDetailsList");
        window.orderSubtotal = document.getElementById("orderSubtotal");
        window.orderTax = document.getElementById("orderTax");
        window.orderTotal = document.getElementById("orderTotal");
        window.cancelOrderBtn = document.getElementById("cancelOrderBtn");
        window.addProductBtn = document.getElementById("addProductBtn");

        // Productos modals
        window.productModal = document.getElementById("productModal");
        window.closeProductModal = document.getElementById("closeProductModal");
        window.productForm = document.getElementById("productForm");
        window.productSelect = document.getElementById("productSelect");
        window.productQuantity = document.getElementById("productQuantity");
        window.productPrice = document.getElementById("productPrice");
        window.cancelProductBtn = document.getElementById("cancelProductBtn");

        // Detalles modals
        window.detailsModal = document.getElementById("detailsModal");
        window.detailsTitle = document.getElementById("detailsTitle");
        window.detailsNumber = document.getElementById("detailsNumber");
        window.detailsStatus = document.getElementById("detailsStatus");
        window.detailsProvider = document.getElementById("detailsProvider");
        window.detailsDate = document.getElementById("detailsDate");
        window.detailsNotes = document.getElementById("detailsNotes");
        window.detailsProductList =
          document.getElementById("detailsProductList");
        window.detailsSubtotal = document.getElementById("detailsSubtotal");
        window.detailsTax = document.getElementById("detailsTax");
        window.detailsTotal = document.getElementById("detailsTotal");
        window.closeDetailsModal = document.getElementById("closeDetailsModal");
        window.closeDetailsBtn = document.getElementById("closeDetailsBtn");
      }

      function setupAxiosInterceptors() {
        axios.interceptors.request.use(
          (request) => {
            console.log("Enviando solicitud a:", request.url);
            console.log("Headers:", request.headers);
            return request;
          },
          (error) => {
            console.error("Error en la solicitud:", error);
            return Promise.reject(error);
          }
        );
      }

      // Funci√≥n para inicializar la aplicaci√≥n
      async function initApp() {
        console.log("Inicializando aplicaci√≥n...");

        try {
          // Primero autenticar
          await authenticate();

          // Configurar event listeners
          setupEventListeners();

          // Luego cargar datos
          await loadProviders();
        } catch (error) {
          console.error("Error de inicializaci√≥n:", error);

          if (
            error.message === "No hay sesi√≥n activa" ||
            error.message === "Sesi√≥n expirada o no v√°lida" ||
            (error.response && error.response.status === 401)
          ) {
            // Error de autenticaci√≥n, redirigir al login
            window.location.href = "/";
          } else {
            // Otro tipo de error, cargar datos de muestra como fallback
            currentProviders = getMockProviders();
            renderProviders();
            showNotification(
              "Error de inicializaci√≥n. Usando datos de muestra.",
              "error"
            );
          }
        }
      }
      function getStoredToken() {
        // Intentar obtener de localStorage primero
        let token = localStorage.getItem("authToken");

        // Si no est√° en localStorage, intentar en sessionStorage
        if (!token) {
          token = sessionStorage.getItem("authToken");
        }

        return token;
      }

      // Funci√≥n de autenticaci√≥n usando la ruta correcta
      async function authenticate() {
        try {
          console.log("Verificando autenticaci√≥n...");

          // Intentar obtener token existente del almacenamiento
          const token = getStoredToken();

          if (token) {
            console.log("‚úÖ Token existente encontrado");

            // Configurar token para todas las peticiones
            axios.defaults.headers.common["Authorization"] = `Bearer ${token}`;

            // Opcionalmente, verificar que el token sea v√°lido haciendo una petici√≥n al backend
            try {
              const userResponse = await axios.get("/auth/me");
              console.log(
                "‚úÖ Token verificado, sesi√≥n v√°lida:",
                userResponse.data
              );
              return true;
            } catch (verifyError) {
              console.error("‚ùå Token existente no v√°lido:", verifyError);
              // Si el token no es v√°lido, eliminarlo del almacenamiento
              localStorage.removeItem("authToken");
              sessionStorage.removeItem("authToken");
              throw new Error("Sesi√≥n expirada o no v√°lida");
            }
          } else {
            console.log("‚ùå No se encontr√≥ token almacenado");
            throw new Error("No hay sesi√≥n activa");
          }
        } catch (error) {
          console.error("Error de autenticaci√≥n:", error);
          throw error;
        }
      }
      // Funci√≥n para cargar el perfil del usuario
      function loadUserProfile() {
        // Intentar obtener los datos del usuario de localStorage o sessionStorage
        let userData =
          JSON.parse(localStorage.getItem("userData")) ||
          JSON.parse(sessionStorage.getItem("userData"));

        if (!userData) {
          console.warn("No se encontraron datos de usuario");
          return;
        }

        // Actualizar el nombre en la barra de navegaci√≥n
        const displayNameElement = document.getElementById("user-display-name");
        if (displayNameElement) {
          displayNameElement.textContent = userData.nombre || "Usuario";
        }

        // Actualizar las iniciales en el avatar
        const initialsElement = document.getElementById("user-initials");
        if (initialsElement) {
          const initials = getInitials(userData.nombre);
          initialsElement.textContent = initials;
        }

        // Actualizar informaci√≥n en el men√∫ desplegable
        const fullNameElement = document.getElementById("user-full-name");
        if (fullNameElement) {
          fullNameElement.textContent = `${userData.nombre} ${
            userData.apellidos || ""
          }`;
        }

        const roleElement = document.getElementById("user-role");
        if (roleElement) {
          const roles = {
            1: "Administrador",
            2: "Vendedor",
            3: "Almac√©n",
            4: "Gerente",
          };
          roleElement.textContent = `Rol: ${
            roles[userData.id_rol] || "Empleado"
          }`;
        }

        const positionElement = document.getElementById("user-position");
        if (positionElement) {
          positionElement.textContent = `Puesto: ${
            userData.puesto || "Sin especificar"
          }`;
        }
      }

      // Funci√≥n para obtener las iniciales de un nombre
      function getInitials(name) {
        if (!name) return "U";

        const parts = name.split(" ");
        if (parts.length === 1) {
          return parts[0].charAt(0).toUpperCase();
        }

        return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
      }

      // Funci√≥n para cerrar sesi√≥n
      function logout() {
        // Eliminar tokens y datos de usuario
        localStorage.removeItem("authToken");
        localStorage.removeItem("userData");
        sessionStorage.removeItem("authToken");
        sessionStorage.removeItem("userData");

        // Redirigir al login
        window.location.href = "/";
      }

      // Cargar el perfil del usuario cuando se carga la p√°gina
      document.addEventListener("DOMContentLoaded", function () {
        loadUserProfile();
      });

      function setupEventListeners() {
        console.log("Configurando event listeners...");

        // Tab Navigation
        proveedoresTab.addEventListener("click", () => {
          proveedoresTab.classList.add(
            "text-red-600",
            "after:content-['']",
            "after:absolute",
            "after:w-full",
            "after:h-0.5",
            "after:bg-red-600",
            "after:bottom-0",
            "after:left-0"
          );
          pedidosTab.classList.remove(
            "text-red-600",
            "after:content-['']",
            "after:absolute",
            "after:w-full",
            "after:h-0.5",
            "after:bg-red-600",
            "after:bottom-0",
            "after:left-0"
          );
          proveedoresContent.classList.remove("hidden");
          proveedoresContent.classList.add("block");
          pedidosContent.classList.add("hidden");
        });

        pedidosTab.addEventListener("click", () => {
          pedidosTab.classList.add(
            "text-red-600",
            "after:content-['']",
            "after:absolute",
            "after:w-full",
            "after:h-0.5",
            "after:bg-red-600",
            "after:bottom-0",
            "after:left-0"
          );
          proveedoresTab.classList.remove(
            "text-red-600",
            "after:content-['']",
            "after:absolute",
            "after:w-full",
            "after:h-0.5",
            "after:bg-red-600",
            "after:bottom-0",
            "after:left-0"
          );
          pedidosContent.classList.remove("hidden");
          proveedoresContent.classList.add("hidden");
          loadOrders();
        });

        // B√∫squeda y filtros
        searchBtn.addEventListener("click", loadProviders);
        searchInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            loadProviders();
          }
        });
        categoryFilter.addEventListener("change", loadProviders);
        statusFilter.addEventListener("change", loadProviders);

        // Modal de proveedor
        addProviderBtn.addEventListener("click", openAddProviderModal);
        closeProviderModal.addEventListener("click", closeProviderModals);
        cancelProviderBtn.addEventListener("click", closeProviderModals);
        providerForm.addEventListener("submit", saveProvider);

        // Modal de pedidos
        addOrderBtn.addEventListener("click", openAddOrderModal);
        closeOrderModal.addEventListener("click", closeOrderModals);
        cancelOrderBtn.addEventListener("click", closeOrderModals);
        orderForm.addEventListener("submit", saveOrder);

        // Modal de productos
        addProductBtn.addEventListener("click", openAddProductModal);
        closeProductModal.addEventListener("click", handleCloseProductModal);
        cancelProductBtn.addEventListener("click", handleCloseProductModal);
        productForm.addEventListener("submit", addProductToOrder);
        productSelect.addEventListener("change", updateProductPrice);

        // Modal de detalles
        if (closeDetailsModal) {
          closeDetailsModal.addEventListener("click", handleCloseDetailsModal);
        }

        if (closeDetailsBtn) {
          closeDetailsBtn.addEventListener("click", handleCloseDetailsModal);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Aseg√∫rate de que todos los elementos existan antes de asignarles event listeners
        const closeDetailsModal = document.getElementById("closeDetailsModal");
        const closeDetailsBtn = document.getElementById("closeDetailsBtn");

        if (closeDetailsModal) {
          closeDetailsModal.addEventListener("click", function () {
            document.getElementById("detailsModal").classList.add("hidden");
          });
        } else {
          console.error("Elemento 'closeDetailsModal' no encontrado");
        }

        if (closeDetailsBtn) {
          closeDetailsBtn.addEventListener("click", function () {
            document.getElementById("detailsModal").classList.add("hidden");
          });
        }
      });

      // Load providers from API con filtros funcionando
      async function loadProviders() {
        console.log("Iniciando carga de proveedores con filtros...");

        // Obtener valores de los filtros
        const searchText = searchInput.value.trim().toLowerCase();
        const categoryValue = categoryFilter.value;
        const statusValue = statusFilter.value;

        console.log("Filtros aplicados:", {
          searchText,
          categoryValue,
          statusValue,
        });

        try {
          // Construir URL con par√°metros
          let url = "/proveedores/";
          let params = [];

          // A√±adir filtro de estado si no es "all"
          if (statusValue !== "all") {
            params.push(`id_status=${statusValue}`);
          }

          // Construir URL con par√°metros
          if (params.length > 0) {
            url += "?" + params.join("&");
          }

          console.log("Solicitando URL:", url);
          const response = await axios.get(url);
          console.log("‚úÖ Proveedores cargados correctamente:", response.data);

          // Guardar todos los proveedores de la API
          let providers = response.data;

          // Aplicar filtrado del lado del cliente
          providers = applyFilters(
            providers,
            searchText,
            categoryValue,
            statusValue
          );

          console.log("Proveedores despu√©s de filtrado:", providers.length);
          currentProviders = providers;
          renderProviders();
          return providers;
        } catch (error) {
          console.error("‚ùå Error cargando proveedores:", error);

          // Intentar sin par√°metros y filtrar del lado del cliente
          try {
            const response = await axios.get("/proveedores/");
            let providers = response.data;

            // Aplicar todos los filtros del lado del cliente
            providers = applyFilters(
              providers,
              searchText,
              categoryValue,
              statusValue
            );

            currentProviders = providers;
            renderProviders();
            return providers;
          } catch {
            // Si ambos intentos fallan, usar datos de muestra con filtros
            let mockProviders = getMockProviders();
            mockProviders = applyFilters(
              mockProviders,
              searchText,
              categoryValue,
              statusValue
            );

            currentProviders = mockProviders;
            renderProviders();
            showNotification(
              "Error al cargar proveedores. Usando datos de muestra.",
              "error"
            );
          }

          throw error;
        }
      }

      // Funci√≥n auxiliar para aplicar todos los filtros del lado del cliente
      function applyFilters(providers, searchText, categoryValue, statusValue) {
        return providers.filter((provider) => {
          // Aplicar filtro de b√∫squeda
          const matchesSearch =
            searchText === "" ||
            provider.nombre.toLowerCase().includes(searchText) ||
            (provider.email &&
              provider.email.toLowerCase().includes(searchText)) ||
            (provider.telefono && provider.telefono.includes(searchText)) ||
            (provider.notas &&
              provider.notas.toLowerCase().includes(searchText));

          // Aplicar filtro de categor√≠a
          const category = getCategoryByName(provider.nombre).toLowerCase();
          const matchesCategory =
            categoryValue === "all" || categoryValue === category;

          // Aplicar filtro de estado (si no se aplic√≥ en la API)
          const matchesStatus =
            statusValue === "all" ||
            provider.id_status.toString() === statusValue;

          // El elemento pasa el filtro si cumple todas las condiciones
          return matchesSearch && matchesCategory && matchesStatus;
        });
      }

      // Render providers in the grid
      function renderProviders() {
        console.log("Iniciando renderizado de proveedores...");
        console.log(
          "N√∫mero de proveedores a renderizar:",
          currentProviders.length
        );

        proveedoresGrid.innerHTML = "";

        if (currentProviders.length === 0) {
          console.log("No hay proveedores para mostrar.");
          proveedoresGrid.innerHTML = `
                            <div class="col-span-3 p-8 text-center text-gray-500">
                                No se encontraron proveedores. Intenta con otros filtros o agrega uno nuevo.
                            </div>
                        `;
          return;
        }

        currentProviders.forEach((provider, index) => {
          console.log(
            `Renderizando proveedor ${index + 1}/${currentProviders.length}:`,
            provider.nombre
          );

          const providerCard = document.createElement("div");
          providerCard.className =
            "bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition transform hover:-translate-y-1";

          // Get first letter of provider name for the logo
          const firstLetter = provider.nombre.charAt(0).toUpperCase();

          providerCard.innerHTML = `
                            <div class="bg-gray-100 p-5 flex items-center gap-4">
                                <div class="w-14 h-14 rounded-lg bg-gray-300 flex items-center justify-center font-bold text-2xl text-gray-600">
                                    ${firstLetter}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-lg">${
                                      provider.nombre
                                    }</h3>
                                    <div class="text-sm text-gray-600">${getCategoryByName(
                                      provider.nombre
                                    )}</div>
                                </div>
                            </div>
                            <div class="p-5">
                                <div class="mb-3">
                                    <div class="text-xs text-gray-500">Contacto</div>
                                    <div class="font-medium">${
                                      provider.email
                                    }</div>
                                </div>
                                <div class="mb-3">
                                    <div class="text-xs text-gray-500">Tel√©fono</div>
                                    <div class="font-medium">${
                                      provider.telefono || "No especificado"
                                    }</div>
                                </div>
                                <div class="mb-3">
                                    <div class="text-xs text-gray-500">Tiempo de entrega</div>
                                    <div class="font-medium">${
                                      provider.tiempo_entrega_promedio
                                        ? provider.tiempo_entrega_promedio +
                                          " d√≠as"
                                        : "No especificado"
                                    }</div>
                                </div>
                                <div class="mb-4">
                                      <div class="text-xs text-gray-500">Estado</div>
                                      <div class="font-medium flex items-center">
                                          <span class="h-2 w-2 rounded-full ${
                                            provider.id_status === 1
                                              ? "bg-green-500"
                                              : "bg-red-500"
                                          } mr-2"></span>
                                          ${
                                            provider.id_status === 1
                                              ? "Activo"
                                              : "Inactivo"
                                          }
                                      </div>
                                  </div>
                                <div class="flex gap-2">
                                    <button class="flex-1 py-2 px-3 bg-gray-100 text-gray-800 rounded font-medium text-sm hover:bg-gray-200 transition" onclick="editProvider(${
                                      provider.id_proveedor
                                    })">Editar</button>
                                    <button class="flex-1 py-2 px-3 bg-red-50 text-red-700 rounded font-medium text-sm hover:bg-red-100 transition" onclick="deleteProvider(${
                                      provider.id_proveedor
                                    })">Eliminar</button>
                                    <button class="flex-1 py-2 px-3 bg-green-50 text-green-700 rounded font-medium text-sm hover:bg-green-100 transition" onclick="createOrder(${
                                      provider.id_proveedor
                                    })">Ordenar</button>
                                    <button class="flex-1 py-2 px-3 bg-blue-50 text-blue-700 rounded font-medium text-sm hover:bg-blue-100 transition" onclick="loadProviderOrders(${
                                      provider.id_proveedor
                                    })">Ver Pedidos
                                      </button>
                                </div>
                            </div>
                        `;

          proveedoresGrid.appendChild(providerCard);
        });

        console.log("Renderizado de proveedores completado.");
      }

      // Open add provider modal
      function openAddProviderModal() {
        console.log("Abriendo modal para a√±adir producto...");
        modalTitle.textContent = "Agregar Proveedor";
        providerId.value = "";
        providerForm.reset();
        providerModal.classList.remove("hidden");
      }

      // Open edit provider modal
      function editProvider(id) {
        const provider = currentProviders.find((p) => p.id_proveedor === id);
        if (!provider) return;

        modalTitle.textContent = "Editar Proveedor";
        providerId.value = provider.id_proveedor;
        providerName.value = provider.nombre;
        providerEmail.value = provider.email;
        providerPhone.value = provider.telefono || "";
        providerDelivery.value = provider.tiempo_entrega_promedio || "";
        providerAddress.value = provider.direccion || "";
        providerCity.value = provider.ciudad || "";
        providerState.value = provider.estado || "";
        providerZip.value = provider.codigo_postal || "";
        providerNotes.value = provider.notas || "";

        providerModal.classList.remove("hidden");
      }

      // Save provider (create or update)
      function saveProvider(e) {
        e.preventDefault();
        console.log("Iniciando guardado de proveedor...");

        const id = providerId.value;
        const providerData = {
          nombre: providerName.value,
          email: providerEmail.value,
          telefono: providerPhone.value,
          tiempo_entrega_promedio: providerDelivery.value
            ? parseInt(providerDelivery.value)
            : null,
          direccion: providerAddress.value,
          ciudad: providerCity.value,
          estado: providerState.value,
          codigo_postal: providerZip.value,
          notas: providerNotes.value,
        };

        console.log("Datos del proveedor a guardar:", providerData);
        console.log("ID del proveedor (si es edici√≥n):", id);

        if (id) {
          // Update existing provider

          console.log(`Actualizando proveedor existente con ID ${id}...`);
          axios
            .put(`/proveedores/${id}`, providerData)
            .then((response) => {
              console.log("Proveedor actualizado exitosamente:", response.data);
              showNotification(
                "Proveedor actualizado correctamente",
                "success"
              );
              closeProviderModals();
              loadProviders();
            })
            .catch((error) => {
              console.error("Error actualizando proveedor:", error);
              if (error.response) {
                console.error("Detalles del error:", error.response.data);
                console.error("Estado HTTP:", error.response.status);
              }
              showNotification(
                "Error al actualizar proveedor: " +
                  (error.response?.data?.detail || error.message),
                "error"
              );
            });
        } else {
          // Create new provider
          console.log("Creando nuevo proveedor...");
          axios
            .post("/proveedores", providerData)
            .then((response) => {
              console.log("Proveedor creado exitosamente:", response.data);
              showNotification("Proveedor creado correctamente", "success");
              closeProviderModals();
              loadProviders();
            })
            .catch((error) => {
              console.error("Error creando proveedor:", error);
              if (error.response) {
                console.error("Detalles del error:", error.response.data);
                console.error("Estado HTTP:", error.response.status);
              }
              showNotification("Error al crear proveedor", "error");
            });
        }
      }

      // Delete provider
      function deleteProvider(id) {
        if (!confirm("¬øEst√° seguro que desea eliminar este proveedor?")) return;

        axios
          .delete(`/proveedores/${id}`)
          .then((response) => {
            // Eliminar el proveedor de la lista actual sin necesidad de recargar
            currentProviders = currentProviders.filter(
              (p) => p.id_proveedor !== id
            );
            renderProviders();

            showNotification("Proveedor eliminado correctamente", "success");
          })
          .catch((error) => {
            console.error("Error al eliminar proveedor:", error);

            if (
              error.response &&
              error.response.data &&
              error.response.data.detail
            ) {
              showNotification(`Error: ${error.response.data.detail}`, "error");
            } else {
              showNotification(
                "Error al eliminar proveedor. Intente nuevamente.",
                "error"
              );
            }
          });
      }

      // Close provider modals
      function closeProviderModals() {
        providerModal.classList.add("hidden");
      }

      // Functions for Orders

      // Load orders from API
      function loadOrders() {
        axios
          .get("/compras")
          .then((response) => {
            currentOrders = response.data;
            renderOrders();
          })
          .catch((error) => {
            console.error("Error loading orders:", error);

            // For demonstration, load mock data
            currentOrders = getMockOrders();
            renderOrders();

            showNotification(
              "Error al cargar pedidos. Usando datos de muestra.",
              "error"
            );
          });
      }

      // Render orders in the table
      function renderOrders() {
        pedidosTableBody.innerHTML = "";

        if (currentOrders.length === 0) {
          pedidosTableBody.innerHTML = `
              <tr>
                  <td colspan="6" class="px-6 py-4 text-sm text-gray-500 text-center">
                      No se encontraron pedidos. Intenta crear uno nuevo.
                  </td>
              </tr>
          `;
          return;
        }

        currentOrders.forEach((order) => {
          const provider = currentProviders.find(
            (p) => p.id_proveedor === order.id_proveedor
          ) || { nombre: "Proveedor no encontrado" };

          const orderRow = document.createElement("tr");

          let statusClass = "";
          let statusLabel = "";

          switch (order.estado) {
            case "pendiente":
              statusClass = "bg-yellow-100 text-yellow-800";
              statusLabel = "Pendiente";
              break;
            case "procesado":
              statusClass = "bg-blue-100 text-blue-800";
              statusLabel = "Procesado";
              break;
            case "entregado":
              statusClass = "bg-green-100 text-green-800";
              statusLabel = "Entregado";
              break;
            case "cancelado":
              statusClass = "bg-red-100 text-red-800";
              statusLabel = "Cancelado";
              break;
            default:
              statusClass = "bg-gray-100 text-gray-800";
              statusLabel = order.estado;
          }

          orderRow.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  ${order.numero_compra}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  ${provider.nombre}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  ${formatDate(order.fecha_orden)}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  $${order.total.toFixed(2)}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                      ${statusLabel}
                  </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="viewOrderDetails(${
                    order.id_compra
                  })">
                      Ver
                  </button>
                  ${
                    order.estado === "pendiente" || order.estado === "procesado"
                      ? `
                      <button class="text-red-600 hover:text-red-900" onclick="cancelarCompra(${order.id_compra})">
                          Cancelar
                      </button>
                      `
                      : ""
                  }
              </td>
          `;

          pedidosTableBody.appendChild(orderRow);
        });
      }

      // Funcion para cargar las ordenes de los pedidos
      function loadProviderOrders(providerId) {
        // Mostrar pesta√±a de pedidos
        pedidosTab.click();

        // Mostrar indicador de carga
        pedidosTableBody.innerHTML = `
          <tr>
              <td colspan="6" class="px-6 py-4 text-center">
                  <div class="flex justify-center">
                      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"></div>
                  </div>
                  <p class="mt-2 text-gray-500">Cargando pedidos del proveedor...</p>
              </td>
          </tr>
      `;

        // Cargar pedidos filtrados por proveedor
        axios
          .get(`/compras?id_proveedor=${providerId}`)
          .then((response) => {
            currentOrders = response.data;
            renderOrders();

            // Si hay resultados, mostrar mensaje
            if (currentOrders.length > 0) {
              showNotification(
                `Se encontraron ${currentOrders.length} pedidos para este proveedor`,
                "success"
              );
            } else {
              showNotification(
                "No se encontraron pedidos para este proveedor",
                "info"
              );
            }
          })
          .catch((error) => {
            console.error("Error cargando pedidos del proveedor:", error);

            // Fallback a datos de prueba filtrados
            currentOrders = getMockOrders().filter(
              (o) => o.id_proveedor == providerId
            );
            renderOrders();

            showNotification(
              "Error al cargar pedidos del proveedor. Usando datos de muestra.",
              "error"
            );
          });
      }

      // Initialize order creation
      function createOrder(providerId) {
        selectedProviderId = providerId;
        openAddOrderModal();
      }
      // Open add order modal
      function openAddOrderModal() {
        orderDetailsList.innerHTML = `
                        <tr id="noProductsRow">
                            <td colspan="5" class="px-4 py-3 text-sm text-gray-500 text-center">No hay productos agregados</td>
                        </tr>
                    `;

        orderForm.reset();
        orderDetails = [];
        updateOrderTotals();

        // Load providers for the dropdown
        orderProvider.innerHTML =
          '<option value="">Seleccionar proveedor</option>';

        // If we don't have providers loaded yet, load them
        if (currentProviders.length === 0) {
          loadProviders();
        }

        currentProviders.forEach((provider) => {
          const option = document.createElement("option");
          option.value = provider.id_proveedor;
          option.textContent = provider.nombre;
          orderProvider.appendChild(option);
        });

        // If a provider was selected (from the provider card)
        if (selectedProviderId) {
          orderProvider.value = selectedProviderId;
        }

        // Load products for the product modal
        loadProducts();

        orderModal.classList.remove("hidden");
      }

      // Load products for order
      function loadProducts() {
        axios
          .get("/productos")
          .then((response) => {
            currentProducts = response.data;
            updateProductsDropdown();
          })
          .catch((error) => {
            console.error("Error loading products:", error);

            // For demonstration, load mock data
            currentProducts = getMockProducts();
            updateProductsDropdown();

            showNotification(
              "Error al cargar productos. Usando datos de muestra.",
              "error"
            );
          });
      }

      // Update products dropdown
      function updateProductsDropdown() {
        productSelect.innerHTML =
          '<option value="">Seleccionar producto</option>';

        currentProducts.forEach((product) => {
          const option = document.createElement("option");
          option.value = product.id_producto;
          option.textContent = `${product.nombre} (SKU: ${product.sku})`;
          option.dataset.price = product.precio_compra;
          productSelect.appendChild(option);
        });
      }

      // Open add product modal
      function openAddProductModal() {
        console.log("Abriendo modal para a√±adir producto...");
        productForm.reset();
        productModal.classList.remove("hidden");
      }

      function handleCloseProductModal() {
        console.log("Cerrando modal de productos...");
        productModal.classList.add("hidden");
      }

      // Update product price based on selected product
      function updateProductPrice() {
        const selectedOption =
          productSelect.options[productSelect.selectedIndex];
        if (selectedOption && selectedOption.dataset.price) {
          productPrice.value = selectedOption.dataset.price;
        } else {
          productPrice.value = "";
        }
      }

      // Add product to order
      function addProductToOrder(e) {
        e.preventDefault();

        const productId = productSelect.value;
        if (!productId) {
          showNotification("Debes seleccionar un producto", "error");
          return;
        }

        const quantity = parseInt(productQuantity.value);
        const price = parseFloat(productPrice.value);

        if (isNaN(quantity) || quantity <= 0) {
          showNotification("La cantidad debe ser mayor a 0", "error");
          return;
        }

        if (isNaN(price) || price <= 0) {
          showNotification("El precio debe ser mayor a 0", "error");
          return;
        }

        const product = currentProducts.find(
          (p) => p.id_producto.toString() === productId
        );
        if (!product) {
          showNotification("Producto no encontrado", "error");
          return;
        }

        // Check if product already exists in order
        const existingProductIndex = orderDetails.findIndex(
          (item) => item.id_producto.toString() === productId
        );

        if (existingProductIndex !== -1) {
          // Update existing product
          orderDetails[existingProductIndex].cantidad_ordenada += quantity;
          orderDetails[existingProductIndex].precio_unitario = price;
          orderDetails[existingProductIndex].subtotal =
            orderDetails[existingProductIndex].cantidad_ordenada * price;
        } else {
          // Add new product
          orderDetails.push({
            id_producto: parseInt(productId),
            producto: product,
            cantidad_ordenada: quantity,
            precio_unitario: price,
            subtotal: quantity * price,
          });
        }

        renderOrderDetails();
        updateOrderTotals();
        handleCloseProductModal();
      }

      // Render order details
      function renderOrderDetails() {
        if (orderDetails.length === 0) {
          orderDetailsList.innerHTML = `
                            <tr id="noProductsRow">
                                <td colspan="5" class="px-4 py-3 text-sm text-gray-500 text-center">No hay productos agregados</td>
                            </tr>
                        `;
          return;
        }

        orderDetailsList.innerHTML = "";

        orderDetails.forEach((detail, index) => {
          const detailRow = document.createElement("tr");

          detailRow.innerHTML = `
                            <td class="px-4 py-3 text-sm">
                                ${detail.producto.nombre}
                            </td>
                            <td class="px-4 py-3 text-sm">
                                ${detail.cantidad_ordenada}
                            </td>
                            <td class="px-4 py-3 text-sm">
                                $${detail.precio_unitario.toFixed(2)}
                            </td>
                            <td class="px-4 py-3 text-sm">
                                $${detail.subtotal.toFixed(2)}
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <button type="button" class="text-red-600 hover:text-red-900" onclick="removeOrderDetail(${index})">
                                    Eliminar
                                </button>
                            </td>
                        `;

          orderDetailsList.appendChild(detailRow);
        });
      }

      // Remove product from order
      function removeOrderDetail(index) {
        orderDetails.splice(index, 1);
        renderOrderDetails();
        updateOrderTotals();
      }

      // Update order totals
      function updateOrderTotals() {
        let subtotal = 0;

        orderDetails.forEach((detail) => {
          subtotal += detail.subtotal;
        });

        const tax = subtotal * 0.16;
        const total = subtotal + tax;

        orderSubtotal.textContent = `$${subtotal.toFixed(2)}`;
        orderTax.textContent = `$${tax.toFixed(2)}`;
        orderTotal.textContent = `$${total.toFixed(2)}`;
      }

      // Mandar correos

      function generarTokenConfirmacion(idPedido) {
        const fecha = new Date().getTime();
        const token = btoa(`${idPedido}-${fecha}-comicspos`); // Codifica en base64
        return token;
      }

      function formatearProductosParaCorreo(productos) {
        return productos.map((producto) => {
          return {
            nombre: producto.producto.nombre,
            cantidad: producto.cantidad_ordenada,
            precio: producto.precio_unitario.toFixed(2),
            subtotal: producto.subtotal.toFixed(2),
          };
        });
      }

      // Funci√≥n para enviar correo electr√≥nico de confirmaci√≥n de pedido
      function enviarCorreoPedido(pedido, proveedor, detalles) {
        // Verificar que EmailJS est√° cargado
        if (typeof emailjs === "undefined") {
          console.error("EmailJS no est√° cargado");
          showNotification(
            "Error al enviar correo: EmailJS no est√° disponible",
            "error"
          );
          return;
        }

        if (!proveedor || !proveedor.email) {
          console.error(
            "Error: No hay direcci√≥n de correo de proveedor v√°lida"
          );
          showNotification(
            "No se pudo enviar el correo: Direcci√≥n de proveedor inv√°lida",
            "error"
          );
          return;
        }

        const emailProveedor = proveedor.email.trim();
        if (!emailProveedor) {
          console.error(
            "Error: Email del proveedor est√° vac√≠o despu√©s de limpiar espacios"
          );
          showNotification(
            "No se pudo enviar el correo: Email inv√°lido",
            "error"
          );
          return;
        }

        console.log("Enviando correo a:", proveedor.email);

        // Calcular totales
        let subtotal = 0;
        detalles.forEach((detalle) => {
          subtotal += detalle.subtotal;
        });
        const iva = subtotal * 0.16;
        const total = subtotal + iva;

        // Formatear la fecha actual
        const fecha = new Date().toLocaleDateString("es-MX", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

        const asuntoConfirmacion = `CONFIRMACI√ìN DE PEDIDO ${pedido.numero_compra}`;
        const cuerpoConfirmacion = `Confirmo el pedido ${pedido.numero_compra}`;
        const urlConfirmacion = `mailto:tiendadecomics89@gmail.com?subject=${encodeURIComponent(
          asuntoConfirmacion
        )}&body=${encodeURIComponent(cuerpoConfirmacion)}`;

        const productosFormateados = formatearProductosParaCorreo(detalles);

        // Generar token de confirmaci√≥n
        // const tokenConfirmacion = generarTokenConfirmacion(pedido.id_compra);

        // const asuntoConfirmacion = `CONFIRMACI√ìN DE PEDIDO ${pedido.numero_compra}`;
        // const cuerpoConfirmacion = `Confirmo el pedido ${pedido.numero_compra} para iniciar su procesamiento.\n\nProveedor: ${proveedor.nombre}\nFecha: ${fecha}\n\nEste es un mensaje autom√°tico de confirmaci√≥n.`;

        // // Codificar para URL
        // const asuntoCodificado = encodeURIComponent(asuntoConfirmacion);
        // const cuerpoCodificado = encodeURIComponent(cuerpoConfirmacion);

        // // Crear enlace mailto
        // const urlConfirmacion = `mailto:tiendadecomics89@gmail.com?subject=${asuntoCodificado}&body=${cuerpoCodificado}`;

        // // Preparar productos formateados para el template
        // const productosFormateados = formatearProductosParaCorreo(detalles);

        // Construir tabla HTML de productos para el correo
        let tablaProductos = "";
        productosFormateados.forEach((prod) => {
          tablaProductos += `
        <tr>
          <td style="padding: 10px; border: 1px solid #ddd;">${prod.nombre}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${prod.cantidad}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${prod.precio}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${prod.subtotal}</td>
        </tr>
      `;
        });

        console.log("Destinatario:", emailProveedor);

        // // Par√°metros para el correo
        // const params = {
        //   service_id: "service_eciq4as",
        //   template_id: "template_d7ek73w",
        //   user_id: "uHkL4ndGHfowv1GB_",
        //   template_params: {
        //     to_email: proveedor.email.trim(),
        //     cc_email: "tiendadecomics89@gmail.com", // Para recibir una copia
        //     numero_pedido: pedido.numero_compra,
        //     proveedor: proveedor.nombre,
        //     fecha: fecha,
        //     estado: "Pendiente",
        //     productos_tabla: tablaProductos,
        //     subtotal: subtotal.toFixed(2),
        //     iva: iva.toFixed(2),
        //     total: total.toFixed(2),
        //     notas: pedido.notas || "Sin notas adicionales",
        //     confirmar_url: urlConfirmacion,
        //   },
        // };

        // console.log("Enviando correo con par√°metros:", params);

        // Enviar correo con EmailJS
        emailjs
          .send(
            "service_eciq4as",
            "template_d7ek73w",
            {
              to_email: proveedor.email.trim(),
              cc_email: "tiendadecomics89@gmail.com",
              numero_pedido: pedido.numero_compra,
              proveedor: proveedor.nombre,
              fecha: fecha,
              estado: "Pendiente",
              productos_tabla: tablaProductos,
              subtotal: subtotal.toFixed(2),
              iva: iva.toFixed(2),
              total: total.toFixed(2),
              notas: pedido.notas || "Sin notas adicionales",
              confirmar_url: urlConfirmacion,
            },
            "uHkL4ndGHfowv1GB_"
          )

          .then(function (response) {
            console.log("Correo enviado exitosamente:", response);
            showNotification(
              "Correo de confirmaci√≥n enviado correctamente",
              "success"
            );
          })
          .catch(function (error) {
            console.error("Error al enviar correo:", error);
            showNotification("Error al enviar correo de confirmaci√≥n", "error");

            console.log("Intentando env√≠o alternativo...");
          });
      }
      // Save order
      function saveOrder(e) {
        e.preventDefault();

        const providerId = orderProvider.value;
        if (!providerId) {
          showNotification("Debes seleccionar un proveedor", "error");
          return;
        }

        if (orderDetails.length === 0) {
          showNotification("Debes agregar al menos un producto", "error");
          return;
        }

        const orderData = {
          id_proveedor: parseInt(providerId),
          fecha_estimada_llegada: orderExpectedDate.value || null,
          detalles: orderDetails.map((detail) => ({
            id_producto: detail.id_producto,
            cantidad_ordenada: detail.cantidad_ordenada,
            precio_unitario: detail.precio_unitario,
            subtotal: detail.subtotal,
          })),
          notas: orderNotes.value,
        };

        axios
          .post("/compras", orderData)
          .then((response) => {
            showNotification("Pedido creado correctamente", "success");

            // Obtener datos del proveedor para el correo
            const proveedor = currentProviders.find(
              (p) => p.id_proveedor == providerId
            );

            // Generar n√∫mero de pedido para el correo
            const pedido = {
              numero_compra:
                response.data.numero_compra ||
                `COMP-${new Date().toISOString().slice(0, 10)}-${Math.floor(
                  Math.random() * 1000
                )}`,
            };

            // Enviar correo de confirmaci√≥n
            enviarCorreoPedido(pedido, proveedor, orderDetails);

            closeOrderModals();
            loadOrders();
            selectedProviderId = null;
          })
          .catch((error) => {
            console.error("Error creating order:", error);

            // Para demostraci√≥n, simulamos un pedido exitoso
            showNotification(
              "Simulando creaci√≥n de pedido (modo demo)",
              "success"
            );

            // Generar un n√∫mero de pedido para la demostraci√≥n
            const pedidoDemo = {
              id_compra: Math.floor(Math.random() * 1000) + 100,
              numero_compra: `COMP-${new Date()
                .toISOString()
                .slice(0, 10)}-${Math.floor(Math.random() * 1000)}`,
              id_proveedor: parseInt(providerId),
              fecha_orden: new Date().toISOString(),
              fecha_estimada_llegada: orderExpectedDate.value || null,
              subtotal: parseFloat(orderSubtotal.textContent.replace("$", "")),
              impuestos: parseFloat(orderTax.textContent.replace("$", "")),
              total: parseFloat(orderTotal.textContent.replace("$", "")),
              estado: "pendiente",
              notas: orderNotes.value,
            };

            // Obtener datos del proveedor para el correo
            const proveedor = currentProviders.find(
              (p) => p.id_proveedor == providerId
            );

            // Enviar correo de confirmaci√≥n
            enviarCorreoPedido(pedidoDemo, proveedor, orderDetails);

            closeOrderModals();

            currentOrders.unshift(pedidoDemo);
            renderOrders();
            selectedProviderId = null;
          });
      }

      // View order details
      function viewOrderDetails(orderId) {
        axios
          .get(`/compras/${orderId}`)
          .then((response) => {
            const order = response.data;
            const provider = currentProviders.find(
              (p) => p.id_proveedor === order.id_proveedor
            ) || { nombre: "Proveedor no encontrado" };
            detailsTitle.textContent = `Detalles del Pedido #${order.id_compra}`;
            detailsNumber.textContent = order.numero_compra;
            let statusLabel = "";
            switch (order.estado) {
              case "pendiente":
                statusLabel = "Pendiente";
                break;
              case "procesado":
                statusLabel = "Procesado";
                break;
              case "entregado":
                statusLabel = "Entregado";
                break;
              case "cancelado":
                statusLabel = "Cancelado";
                break;
              default:
                statusLabel = order.estado;
            }

            detailsStatus.textContent = statusLabel;
            detailsProvider.textContent = provider.nombre;
            detailsDate.textContent = formatDate(order.fecha_orden);
            detailsNotes.textContent = order.notas || "Sin notas";

            // Mostrar detalles de productos
            detailsProductList.innerHTML = "";

            order.detalles.forEach((detail) => {
              const product = currentProducts.find(
                (p) => p.id_producto === detail.id_producto
              ) || { nombre: "Producto no encontrado" };

              const detailRow = document.createElement("tr");
              detailRow.innerHTML = `
                      <td class="px-4 py-3 text-sm">${product.nombre}</td>
                      <td class="px-4 py-3 text-sm">${
                        detail.cantidad_ordenada
                      }</td>
                      <td class="px-4 py-3 text-sm">$${detail.precio_unitario.toFixed(
                        2
                      )}</td>
                      <td class="px-4 py-3 text-sm">$${detail.subtotal.toFixed(
                        2
                      )}</td>
                  `;

              detailsProductList.appendChild(detailRow);
            });

            // Configurar totales
            detailsSubtotal.textContent = `$${order.subtotal.toFixed(2)}`;
            detailsTax.textContent = `$${order.impuestos.toFixed(2)}`;
            detailsTotal.textContent = `$${order.total.toFixed(2)}`;

            // Mostrar modal
            detailsModal.classList.remove("hidden");
          })
          .catch((error) => {
            console.error("Error al cargar detalles del pedido:", error);

            // Fallback a datos de prueba
            const order = currentOrders.find((o) => o.id_compra === orderId);
            if (order) {
              const mockDetails = getMockOrderDetails(orderId);

              showNotification(
                "Error al cargar detalles exactos del pedido. Mostrando aproximaci√≥n.",
                "warning"
              );
            } else {
              showNotification("No se pudo cargar el pedido.", "error");
            }
          });
      }

      // Cancel order
      function cancelOrder(orderId) {
        if (!confirm("¬øEst√° seguro que desea cancelar este pedido?")) return;

        axios
          .post(`/compras/${orderId}/cancelar`)
          .then((response) => {
            showNotification("Pedido cancelado correctamente", "success");
            loadOrders(); // Recargar la lista de pedidos
          })
          .catch((error) => {
            console.error("Error al cancelar pedido:", error);
            showNotification(
              `Error al cancelar pedido: ${
                error.response?.data?.detail || error.message
              }`,
              "error"
            );

            // Si estamos en modo de desarrollo/demo, simulamos la cancelaci√≥n
            if (process.env.NODE_ENV === "development") {
              const orderIndex = currentOrders.findIndex(
                (o) => o.id_compra === orderId
              );
              if (orderIndex !== -1) {
                currentOrders[orderIndex].estado = "cancelado";
                renderOrders();
                showNotification(
                  "Pedido cancelado correctamente (modo demo)",
                  "success"
                );
              }
            }
          });
      }

      //   Cancelar Compra

      function cancelarCompra(compraId) {
        if (
          !confirm(
            "¬øEst√° seguro que desea cancelar esta compra? Esta acci√≥n no se puede deshacer."
          )
        ) {
          return;
        }

        axios
          .post(`/compras/${compraId}/cancelar`)
          .then((response) => {
            console.log("Compra cancelada exitosamente:", response.data);
            showNotification("Compra cancelada exitosamente", "success");

            // Actualizar estado en la lista actual
            const compraIndex = currentOrders.findIndex(
              (o) => o.id_compra === compraId
            );
            if (compraIndex !== -1) {
              currentOrders[compraIndex].estado = "cancelado";
              renderOrders(); // Volver a renderizar la tabla
            }

            // Opcionalmente, recargar todas las compras desde la API
            loadOrders();
          })
          .catch((error) => {
            console.error("Error al cancelar la compra:", error);

            // Mostrar mensaje de error espec√≠fico si est√° disponible
            if (
              error.response &&
              error.response.data &&
              error.response.data.detail
            ) {
              showNotification(`Error: ${error.response.data.detail}`, "error");
            } else {
              showNotification(
                "Error al cancelar la compra. Intente nuevamente.",
                "error"
              );
            }
          });
      }

      // Close order modals
      function closeOrderModals() {
        orderModal.classList.add("hidden");
      }

      // Close product modal
      function handleCloseProductModal() {
        productModal.classList.add("hidden");
      }

      // Close details modal
      function handleCloseDetailsModal() {
        detailsModal.classList.add("hidden");
      }

      // Helper Functions

      // Format date
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("es-MX", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Determine category by name (for demo)
      function getCategoryByName(name) {
        name = name.toLowerCase();
        if (name.includes("marvel") || name.includes("dc")) return "Comics";
        if (
          name.includes("manga") ||
          name.includes("anime") ||
          name.includes("jump")
        )
          return "Manga";
        if (name.includes("funko") || name.includes("merch"))
          return "Merchandising";
        return "Otros";
      }

      // Show notification
      function showNotification(message, type = "success") {
        console.log(`NOTIFICACI√ìN [${type}]: ${message}`);
        if (type === "error") {
          alert(`ERROR: ${message}`);
        } else {
          alert(`√âXITO: ${message}`);
        }
      }

      // Mock Data for demo

      function getMockProviders() {
        return [
          {
            id_proveedor: 1,
            nombre: "Marvel Comics",
            email: "john.smith@marvel.com",
            telefono: "+1 (555) 123-4567",
            direccion: "10 Marvel Way",
            ciudad: "New York",
            estado: "NY",
            codigo_postal: "10001",
            notas: "Proveedor principal de comics Marvel",
            tiempo_entrega_promedio: 7,
            id_status: 1,
          },
          {
            id_proveedor: 2,
            nombre: "DC Comics",
            email: "jane.doe@dc.com",
            telefono: "+1 (555) 987-6543",
            direccion: "1700 Broadway",
            ciudad: "New York",
            estado: "NY",
            codigo_postal: "10019",
            notas: "Proveedor principal de comics DC",
            tiempo_entrega_promedio: 8,
            id_status: 1,
          },
          {
            id_proveedor: 3,
            nombre: "Shonen Jump",
            email: "t.yamamoto@shonenjump.jp",
            telefono: "+81 3-1234-5678",
            direccion: "2-5-10 Hitotsubashi",
            ciudad: "Tokio",
            estado: "",
            codigo_postal: "100-8050",
            notas: "Proveedor principal de manga",
            tiempo_entrega_promedio: 15,
            id_status: 1,
          },
          {
            id_proveedor: 4,
            nombre: "Planeta Comics",
            email: "c.rodriguez@planeta.es",
            telefono: "+34 91 123 45 67",
            direccion: "Av. Diagonal, 662-664",
            ciudad: "Barcelona",
            estado: "",
            codigo_postal: "08034",
            notas: "Distribuidor espa√±ol de comics",
            tiempo_entrega_promedio: 12,
            id_status: 1,
          },
          {
            id_proveedor: 5,
            nombre: "Funko Merch",
            email: "mike.j@funko.com",
            telefono: "+1 (555) 456-7890",
            direccion: "2802 Wetmore Ave",
            ciudad: "Everett",
            estado: "WA",
            codigo_postal: "98201",
            notas: "Figuras Funko Pop y merchandising",
            tiempo_entrega_promedio: 10,
            id_status: 1,
          },
          {
            id_proveedor: 6,
            nombre: "Panini M√©xico",
            email: "a.martinez@panini.mx",
            telefono: "+52 55 1234 5678",
            direccion: "Av. Patriotismo 635",
            ciudad: "Ciudad de M√©xico",
            estado: "CDMX",
            codigo_postal: "03710",
            notas: "Distribuidor oficial de comics y mangas en M√©xico",
            tiempo_entrega_promedio: 5,
            id_status: 1,
          },
        ];
      }

      function getMockOrders() {
        return [
          {
            id_compra: 1,
            numero_compra: "PED-20230415-A1B2C",
            id_proveedor: 1,
            fecha_orden: "2023-04-15T10:30:00",
            fecha_estimada_llegada: "2023-04-22",
            fecha_recepcion: null,
            subtotal: 5000,
            impuestos: 800,
            total: 5800,
            estado: "pendiente",
            id_empleado: 1,
            notas: "Pedido de nuevos lanzamientos Marvel",
          },
          {
            id_compra: 2,
            numero_compra: "PED-20230410-X7Y8Z",
            id_proveedor: 2,
            fecha_orden: "2023-04-10T14:20:00",
            fecha_estimada_llegada: "2023-04-18",
            fecha_recepcion: "2023-04-17",
            subtotal: 3500,
            impuestos: 560,
            total: 4060,
            estado: "entregado",
            id_empleado: 1,
            notas: "Pedido mensual DC Comics",
          },
          {
            id_compra: 3,
            numero_compra: "PED-20230405-D4E5F",
            id_proveedor: 3,
            fecha_orden: "2023-04-05T09:15:00",
            fecha_estimada_llegada: "2023-04-20",
            fecha_recepcion: null,
            subtotal: 4200,
            impuestos: 672,
            total: 4872,
            estado: "procesado",
            id_empleado: 2,
            notas: "Pedido trimestral de mangas",
          },
          {
            id_compra: 4,
            numero_compra: "PED-20230401-G7H8I",
            id_proveedor: 5,
            fecha_orden: "2023-04-01T11:45:00",
            fecha_estimada_llegada: "2023-04-11",
            fecha_recepcion: null,
            subtotal: 2800,
            impuestos: 448,
            total: 3248,
            estado: "cancelado",
            id_empleado: 1,
            notas: "Pedido figuritas Funko - Cancelado por falta de stock",
          },
        ];
      }

      function getMockProducts() {
        return [
          {
            id_producto: 1,
            sku: "BAT-001",
            nombre: "Batman: A√±o Uno",
            descripcion: "Comic Batman A√±o Uno",
            id_categoria: 1,
            stock_actual: 15,
            stock_minimo: 5,
            precio_compra: 150.0,
            precio_venta: 299.99,
            fecha_lanzamiento: "1986-02-01",
            imagen_url: "batman.jpg",
            id_proveedor: 2,
            id_status: 1,
          },
          {
            id_producto: 2,
            sku: "SPM-001",
            nombre: "Spider-Man: No Way Home",
            descripcion: "Comic Spider-Man No Way Home",
            id_categoria: 1,
            stock_actual: 8,
            stock_minimo: 3,
            precio_compra: 180.0,
            precio_venta: 349.99,
            fecha_lanzamiento: "2021-12-01",
            imagen_url: "spiderman.jpg",
            id_proveedor: 1,
            id_status: 1,
          },
          {
            id_producto: 3,
            sku: "WCM-001",
            nombre: "Watchmen",
            descripcion: "Comic Watchmen",
            id_categoria: 1,
            stock_actual: 5,
            stock_minimo: 2,
            precio_compra: 250.0,
            precio_venta: 499.99,
            fecha_lanzamiento: "1986-09-01",
            imagen_url: "watchmen.jpg",
            id_proveedor: 2,
            id_status: 1,
          },
          {
            id_producto: 4,
            sku: "OPC-098",
            nombre: "One Piece Vol. 98",
            descripcion: "Manga One Piece Volumen 98",
            id_categoria: 2,
            stock_actual: 20,
            stock_minimo: 5,
            precio_compra: 100.0,
            precio_venta: 199.99,
            fecha_lanzamiento: "2021-02-01",
            imagen_url: "onepiece.jpg",
            id_proveedor: 3,
            id_status: 1,
          },
          {
            id_producto: 5,
            sku: "DSL-010",
            nombre: "Demon Slayer Vol. 10",
            descripcion: "Manga Demon Slayer Volumen 10",
            id_categoria: 2,
            stock_actual: 12,
            stock_minimo: 3,
            precio_compra: 95.0,
            precio_venta: 189.99,
            fecha_lanzamiento: "2020-01-01",
            imagen_url: "demonslayer.jpg",
            id_proveedor: 3,
            id_status: 1,
          },
          {
            id_producto: 7,
            sku: "FNK-001",
            nombre: "Funko Pop Iron Man",
            descripcion: "Figura Funko Pop Iron Man",
            id_categoria: 3,
            stock_actual: 10,
            stock_minimo: 3,
            precio_compra: 175.0,
            precio_venta: 349.99,
            fecha_lanzamiento: "2018-05-01",
            imagen_url: "funko.jpg",
            id_proveedor: 5,
            id_status: 1,
          },
        ];
      }

      function getMockOrderDetails(orderId) {
        const products = getMockProducts();

        // Generate random details based on order ID
        const numProducts = Math.floor(Math.random() * 4) + 1; // 1-4 products
        const details = [];

        for (let i = 0; i < numProducts; i++) {
          const randomProduct =
            products[Math.floor(Math.random() * products.length)];
          const quantity = Math.floor(Math.random() * 10) + 1; // 1-10 quantity
          const price = randomProduct.precio_compra;

          details.push({
            id_detalle: i + 1,
            id_compra: orderId,
            id_producto: randomProduct.id_producto,
            cantidad_ordenada: quantity,
            cantidad_recibida: 0,
            precio_unitario: price,
            subtotal: price * quantity,
            estado: "pendiente",
          });
        }

        return details;
      }

      // Llamar a la funci√≥n de inicio cuando se cargue el DOM
      document.addEventListener("DOMContentLoaded", initApp);
    </script>
  </body>
</html>
